name: checks
run-name: nix flake check
on:
  - pull_request
jobs:
  nix-flake-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: install Nix
        uses: nixbuild/nix-quick-install-action@master
      - name: Set up Nix cache
        uses: nix-community/cache-nix-action@main
        with:
          primary-key: nix-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('**/*.nix', '**/flake.lock') }}
          restore-prefixes-first-match: nix-${{ runner.os }}-${{ runner.arch }}
      - run: nix flake check --all-systems

  e2e:
    runs-on: ubuntu-latest
    needs: nix-flake-check
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: install Nix
        uses: nixbuild/nix-quick-install-action@master
      - name: Set up Nix cache
        uses: nix-community/cache-nix-action@main
        with:
          primary-key: nix-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('**/*.nix', '**/flake.lock') }}
          restore-prefixes-first-match: nix-${{ runner.os }}-${{ runner.arch }}
      - name: generate registry for inputs.nixpkgs
        run: nix run .#rippkgs-index -- nixpkgs -o rippkgs-index.sqlite "$(nix flake metadata --inputs-from . --json nixpkgs | jq -r .path)"
      - name: use jq
        run: export PATH="$(nix build --print-out-paths --inputs-from . nixpkgs#jq | head -n 1):$PATH"
      - name: rippkgs --exact zsh
        run: nix run .#rippkgs -- --json --exact zsh | jq -f .github/workflows/validate-exact-zsh.jq
      - name: rippkgs zsh
        run: nix run .#rippkgs -- --json zsh | jq -f .github/workflows/validate-fuzzy-zsh.jq
